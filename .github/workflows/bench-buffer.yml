name: Buffer Bench & Validate

on:
  pull_request:
    branches: ['**']
    paths:
      - 'packages/buffer/**'
      - 'scripts/**'
      - '.github/workflows/bench-buffer.yml'
      - 'package.json'
      - 'pnpm-lock.yaml'
  workflow_dispatch: {}

jobs:
  bench-macos:
    name: macOS bench (authoritative)
    runs-on: macos-latest
    permissions:
      contents: read
    concurrency:
      group: bench-buffer-${{ github.ref }}
      cancel-in-progress: true
    env:
      JSON_OUTPUT: "1"
      BENCH_FORCE_EXIT: "1"
      CI: "true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Prepare helpers (5m guard + diagnostics)
        shell: bash
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/ci_helpers.sh <<'SH'
          set -Eeuo pipefail
          run5() {
            local log="$1"; shift
            : > "$log"
            ( "$@" ) > >(tee -a "$log") 2> >(tee -a "$log" >&2) &
            local cmd_pid=$!
            (
              for i in $(seq 1 300); do
                if ! kill -0 "$cmd_pid" 2>/dev/null; then exit 0; fi
                sleep 1
              done
              echo "::error::Step exceeded 5 minutes, killing PID $cmd_pid"
              kill -9 "$cmd_pid" 2>/dev/null || true
              exit 124
            ) &
            local watchdog_pid=$!
            wait "$cmd_pid"; local rc=$?
            kill "$watchdog_pid" 2>/dev/null || true
            if [ $rc -ne 0 ]; then
              echo "----- FAILURE DIAGNOSTICS ($log) -----"
              grep -m1 -Ei '(^|[^a-zA-Z])(error|fail|exception|traceback)([^a-zA-Z]|$)' "$log" || true
              echo "----- LAST 30 LINES -----"
              tail -n 30 "$log" || true
            fi
            return $rc
          }
          SH
          chmod +x .github/scripts/ci_helpers.sh

      - name: Smoke deterministic exit (5m cap)
        shell: bash
        run: bash -Eeuo pipefail -c ". .github/scripts/ci_helpers.sh; run5 smoke-run.log pnpm bench:buffer:smoke"

      - name: Run JSON benchmark (forced, 5m cap)
        shell: bash
        run: |
          bash -Eeuo pipefail -c ". .github/scripts/ci_helpers.sh; run5 bench-run.log pnpm bench:buffer:json:force"
          cp bench-run.log bench-buffer.out
          perl -ne 'print if /^[\\[{]/' bench-run.log > bench-buffer.json

      - name: Stamp BENCHMARKS metadata
        run: node scripts/update-bench-metadata.mjs || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: buffer-bench
          path: |
            bench-buffer.json
            bench-buffer.out
            packages/buffer/BENCHMARKS.md
          if-no-files-found: warn
          retention-days: 14

  validate-linux:
    name: Linux validate + PR comment
    runs-on: ubuntu-latest
    needs: bench-macos
    permissions:
      contents: read
      pull-requests: write
    env:
      BENCH_THR_MIN: ${{ vars.BENCH_THR_MIN }}
      BENCH_P95_MAX_MS: ${{ vars.BENCH_P95_MAX_MS }}
      BENCH_MEM_PER_OP_MAX: ${{ vars.BENCH_MEM_PER_OP_MAX }}
      BENCH_RSS_MAX_MB: ${{ vars.BENCH_RSS_MAX_MB }}
    steps:
      - name: Checkout (for scripts only)
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install deps (for validator)
        run: pnpm install --frozen-lockfile

      - name: Prepare helpers (5m guard + diagnostics)
        shell: bash
        run: |
          mkdir -p .github/scripts
          cat > .github/scripts/ci_helpers.sh <<'SH'
          set -Eeuo pipefail
          run5() {
            local log="$1"; shift
            : > "$log"
            ( "$@" ) > >(tee -a "$log") 2> >(tee -a "$log" >&2) &
            local cmd_pid=$!
            (
              for i in $(seq 1 300); do
                if ! kill -0 "$cmd_pid" 2>/dev/null; then exit 0; fi
                sleep 1
              done
              echo "::error::Step exceeded 5 minutes, killing PID $cmd_pid"
              kill -9 "$cmd_pid" 2>/dev/null || true
              exit 124
            ) &
            local watchdog_pid=$!
            wait "$cmd_pid"; local rc=$?
            kill "$watchdog_pid" 2>/dev/null || true
            if [ $rc -ne 0 ]; then
              echo "----- FAILURE DIAGNOSTICS ($log) -----"
              grep -m1 -Ei '(^|[^a-zA-Z])(error|fail|exception|traceback)([^a-zA-Z]|$)' "$log" || true
              echo "----- LAST 30 LINES -----"
              tail -n 30 "$log" || true
            fi
            return $rc
          }
          SH
          chmod +x .github/scripts/ci_helpers.sh

      - name: Download macOS bench artifacts
        uses: actions/download-artifact@v4
        with:
          name: buffer-bench
          path: ./bench-artifacts

      - name: Validate metrics (Linux, 5m cap)
        shell: bash
        run: |
          . .github/scripts/ci_helpers.sh
          if [ -f ./bench-artifacts/bench-buffer.json ]; then
            run5 validate-run.log node scripts/check-bench-json.mjs ./bench-artifacts/bench-buffer.json
          else
            echo "bench-buffer.json artifact not found; benchmarking job may have failed." | tee -a validate-run.log
            exit 1
          fi

      - name: Comment summary on PR (sticky with run link)
        if: ${{ always() && github.event_name == 'pull_request' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const runId = context.runId;
            const artifactUrl = `https://github.com/${owner}/${repo}/actions/runs/${runId}`;
            const filePath = './bench-artifacts/bench-buffer.json';
            let body;
            if (fs.existsSync(filePath)) {
              const lines = fs.readFileSync(filePath, 'utf8').trim().split('\n');
              const records = lines.map(line => { try { return JSON.parse(line); } catch { return null; } }).filter(Boolean);
              const summary = [...records].reverse().find(record => record.type === 'summary') ?? records.at(-1);
              const metrics = summary?.metrics ?? summary ?? {};
              const throughput = metrics.throughputPerSec !== undefined
                ? metrics.throughputPerSec.toLocaleString(undefined, { maximumFractionDigits: 0 })
                : 'n/a';
              const p95 = metrics.latency?.p95Ms !== undefined ? metrics.latency.p95Ms.toFixed(3) + ' ms' : 'n/a';
              const memory = metrics.memory?.bytesPerInteraction !== undefined ? metrics.memory.bytesPerInteraction.toFixed(0) + ' B' : 'n/a';
              const rss = metrics.rssPeakMB !== undefined ? metrics.rssPeakMB.toFixed(2) + ' MB' : 'n/a';
              body = [
                '### üß™ Buffer Bench Summary (macOS run)',
                '',
                `**Throughput:** ${throughput} ops/s`,
                `**p95 Latency:** ${p95}`,
                `**Memory/op:** ${memory}`,
                `**Peak RSS:** ${rss}`,
                '',
                `[Artifacts & logs](${artifactUrl})`,
                '',
                '_Workflow: Buffer Bench & Validate_',
                '<!-- bench-buffer-summary -->'
              ].join('\n');
            } else {
              body = [
                '### ‚ö†Ô∏è Buffer Bench Summary',
                '',
                'Benchmark artifact not found (macOS job may have failed).',
                `[Run details](${artifactUrl})`,
                '',
                '_Workflow: Buffer Bench & Validate_',
                '<!-- bench-buffer-summary -->'
              ].join('\n');
            }
            const issue_number = context.issue.number;
            const existing = await github.rest.issues.listComments({ owner, repo, issue_number, per_page: 100 });
            const previous = existing.data.find(comment => comment.user?.type === 'Bot' && comment.body?.includes('<!-- bench-buffer-summary -->'));
            if (previous) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: previous.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number, body });
            }
